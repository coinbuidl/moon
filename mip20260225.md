# MIP 20260225: Moon-Managed Context Window and Compaction (No Prune)

## Goal

Integrate moon with OpenClaw context management so moon becomes the controller for context window behavior and compaction timing, while disabling pruning in the target policy.

## Non-Negotiable Requirement

Moon must be the single compaction authority.

1. When moon watcher is active, OpenClaw auto-compaction must be disabled.
2. `/compact` must be triggered only by moon orchestration.
3. Any config drift that re-enables OpenClaw auto-compaction must be detected and reported as a policy violation.

## Implementation Plan

1. Define a first-class context policy in moon config.
   - Add a new `[context]` section in `moon.toml.example`.
   - Fields:
     - `window_mode = "inherit" | "fixed"`
     - `window_tokens` (used only when `window_mode = "fixed"`)
     - `prune_mode = "disabled" | "guarded"`
     - `compaction_authority = "moon" | "openclaw"`
     - `compaction_start_ratio` (for example `0.78`)
     - `compaction_emergency_ratio` (for example `0.90`)
     - `compaction_recover_ratio` (for example `0.65`, hysteresis)

2. Make install/repair honor context policy.
   - In `src/openclaw/config.rs`, stop auto-seeding `contextPruning` when policy is disabled.
   - In `src/commands/install.rs`, apply policy to `openclaw.json` deterministically:
     - `inherit` -> leave `agents.defaults.contextTokens` unset.
     - `fixed` -> set explicit `agents.defaults.contextTokens`.
     - `prune_mode=disabled` -> remove/disable pruning config.
     - `compaction_authority=moon` -> force OpenClaw auto-compaction mode to off/manual (provider-supported setting).

3. Upgrade watcher to compaction-first lifecycle.
   - In `src/moon/watcher.rs` and `src/moon/thresholds.rs`:
     - Use per-session `used/max` from `openclaw sessions --json`.
     - Trigger `archive -> index -> /compact` at `compaction_start_ratio`.
     - Bypass cooldown at `compaction_emergency_ratio`.
     - Do not re-trigger until usage falls below `compaction_recover_ratio`.
   - Keep archive index-note behavior unchanged.

4. Align status and observability.
   - In `src/commands/status.rs`, report effective policy:
     - context source (`inherit` vs fixed cap),
     - pruning state (`disabled` vs guarded),
     - compaction authority (`moon` vs `openclaw`),
     - compaction thresholds and hysteresis.
   - Add explicit drift warnings if OpenClaw config diverges from moon policy.
   - Treat OpenClaw auto-compaction enabled while moon authority is active as `ok=false` violation.

5. Tests and migration.
   - Add tests for:
     - policy application to OpenClaw config,
     - no-prune behavior,
     - emergency compaction path,
     - hysteresis suppression,
     - single-authority enforcement (OpenClaw auto-compaction disabled),
     - drift detection when OpenClaw auto-compaction is re-enabled externally.
   - Maintain backward compatibility: if `[context]` is absent, preserve current behavior until user opts in.

## Acceptance Criteria

1. With `compaction_authority=moon`, OpenClaw auto-compaction is disabled after `moon install/repair`.
2. Every compaction performed in moon watcher follows `archive -> index -> projection(.md) -> /compact`.
3. If OpenClaw auto-compaction is re-enabled externally, `moon status` reports a hard policy violation.
4. No dual-trigger mode exists when moon authority is enabled.

## Recommended Defaults for Current Deployment

1. `window_mode = "inherit"`
2. `prune_mode = "disabled"`
3. `compaction_authority = "moon"`
4. `compaction_start_ratio = 0.78`
5. `compaction_emergency_ratio = 0.90`
6. `compaction_recover_ratio = 0.65`
