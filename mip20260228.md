# MIP-20260228: Operational Safety & Config Hardening

## üéØ Objective
Harden the `moon` daemon and CLI against environmental misuse, silent crashes, stale state, and out-of-sync binaries. Improve config ergonomics without merging `.env` and `moon.toml`.

---

## ‚öôÔ∏è Config Improvements (`.env` + `moon.toml`)

> The dual-config split stays: `.env` for secrets/paths, `moon.toml` for tuning. These improvements make the existing system more robust.

### 1. Typo Detection
- Scan all `MOON_*` environment variables against a known-keys allowlist on startup.
- Warn on unrecognized keys (e.g., `MOON_DISTIL_PROVIDER` ‚Üí "Did you mean `MOON_DISTILL_PROVIDER`?").
- Implementation: static `&[&str]` list in `config.rs`, checked in `load_config()`.

### 2. Secret Masking
- Never echo API keys in `moon status`, `moon verify`, or log output.
- `mask_secret()` helper: show `sk-...a3f2` (first 3 + last 4 chars), or `[SET]`/`[UNSET]`.
- Apply to: `GEMINI_API_KEY`, `OPENAI_API_KEY`, `ANTHROPIC_API_KEY`, `AI_API_KEY`.

### 3. Config Dump (`moon config --show`)
- Print the fully resolved config: defaults ‚Üí `moon.toml` overrides ‚Üí `.env` overrides.
- Shows exactly what moon is running with ‚Äî invaluable for debugging.
- Secrets are masked in output.

### 4. Missing `.env` Warning
- On startup, if `.env` is not found, log: "`.env` not found ‚Äî distill/embed features will be unavailable."
- Non-fatal ‚Äî daemon still boots for basic operations.

---

## üõ°Ô∏è Safety Protocols: The Full Picture

### P0 ‚Äî Must-Do (Prevents Real Failures)

#### 1. Build UUID (Code-Consistency Enforcement)
- **The Risk**: Agents hot-loading settings when `src/` has changed without a rebuild.
- **The Protocol**: Embed a **Build UUID** at compile-time via `build.rs`.
- **Enforcement**: CLI verifies its Build UUID against the running daemon's. Mismatch ‚Üí refuse "Reload" signals, prompt `moon restart --rebuild`.
- **Implementation**: Extend the existing `EmbedLockPayload` pattern (already stores PID + timestamp in `embed.rs`) to the daemon lock.

#### 2. PID & Lockfile Integrity
- **The Risk**: Stale `.lock` files or zombie processes from rapid start/stop cycles.
- **The Protocol**: Liveness verification ‚Äî lift the `embed.rs` lock pattern to the daemon level.
- **Enforcement**:
    - `.lock` file stores PID + start-timestamp + Build UUID.
    - `moon start` performs `kill(0, pid)` liveness check.
    - Stale lock (dead PID or mismatched Build UUID) ‚Üí auto-remediate.

#### 3. Panic Guard in Daemon Loop
- **The Risk**: `run_once_with_options()` in `watcher.rs` is ~940 lines. Any panic inside it kills the daemon silently ‚Äî no log, no alert, just gone.
- **The Protocol**: Wrap each watcher cycle in `std::panic::catch_unwind()`.
- **Enforcement**: On panic ‚Üí log the backtrace, increment a panic counter in state, continue to next cycle. If 3 consecutive panics ‚Üí halt and log `DAEMON_PANIC_HALT`.

#### 4. State File Corruption Recovery
- **The Risk**: `moon_state.json` becomes corrupt (partial write, power loss, disk full). Daemon refuses to start.
- **The Protocol**: Defensive deserialization.
- **Enforcement**: If JSON parse fails ‚Üí backup corrupt file as `moon_state.json.corrupt.{timestamp}`, start with fresh defaults, log `WARN: state file corrupt, starting fresh`.

### P1 ‚Äî Should-Do (Prevents Common Issues)

#### 5. CWD Validation (Working Dir Lock)
- **The Risk**: Running `moon` from a wrong directory, resolving `moon.toml` or data paths incorrectly.
- **The Protocol**: On first boot, daemon records `MOON_HOME` absolute path in the lockfile.
- **Enforcement**: Every command validates CWD. Wrong workspace ‚Üí `ERR_OUT_OF_BOUNDS`.
- **Escape hatch**: `--allow-out-of-bounds` flag.

#### 6. Graceful Shutdown
- **The Risk**: Daemon `run_daemon()` uses `thread::sleep`. No signal handling. `Ctrl+C` or `SIGTERM` kills mid-write, potentially corrupting state or archives.
- **The Protocol**: `Arc<AtomicBool>` shutdown flag + `ctrlc` crate signal handler.
- **Enforcement**: On signal ‚Üí set flag, finish current cycle, flush state, exit cleanly.

#### 7. External Command Timeouts
- **The Risk**: A subprocess (QMD, OpenClaw) hangs forever, stalling the entire watcher cycle indefinitely.
- **The Protocol**: All external command invocations use `run_command_with_optional_timeout()` (already exists in `qmd.rs`).
- **Enforcement**: Audit all `Command::new()` call sites. Any without a timeout gets one. Default: 120 seconds.

#### 8. Secret Masking (see Config section above)

### P2 ‚Äî Nice-to-Have (Quality of Life)

#### 8b. Suppress No-Op Embed Logs ‚úÖ (already fixed)
- **The Issue**: Every watcher cycle calls `audit::append_event` for embed even when `skip_reason=none` and `embedded_docs=0` (all files already up-to-date). This prints on every 30s cycle indefinitely.
- **The Fix**: Gate the audit log on `!(skip_reason == "none" && embedded_docs == 0)`. Logs still appear for real work, cooldown, locked, capability-missing, or degraded.
- **Location**: `watcher.rs` lines 1478‚Äì1498.


#### 9. Log Rotation
- Logs in `MOON_LOGS_DIR` grow unbounded on long-running daemons.
- Simple policy: keep last N log files, or rotate at X MB.

#### 10. Health Probe (`moon health`)
- Single command to check: daemon alive? state file writable? last cycle succeeded? last cycle age reasonable?
- Gives agents one reliable pre-flight check.

#### 11. Dry-Run Everywhere
- `moon install` has `--dry-run`, but watcher/distill/embed don't.
- Adding `--dry-run` to all mutating commands makes testing safer.

#### 12. Structured Error Codes
- Currently errors are `anyhow` strings. Assign codes (e.g., `E001: stale lock`, `E002: CWD mismatch`).
- Agents can react programmatically instead of parsing error text.

---

## ‚ö†Ô∏è Logic Issues to Resolve

### 1. `catch_unwind` vs `panic=abort`
- If `Cargo.toml` sets `panic = "abort"` in any profile, `std::panic::catch_unwind()` is a **no-op** ‚Äî the process just dies.
- **Resolution**: Before implementing P3 (panic guard), confirm `panic` is not set to `abort` in `[profile.release]`. If it is, consider switching to `unwind` or use a subprocess-based isolation model instead.

### 2. Disk-Full During Corrupt State Backup (P4)
- P4 plans to backup `moon_state.json.corrupt.{timestamp}` before starting fresh. If the disk is full (which may be why the state write failed in the first place), this backup write will also fail.
- **Resolution**: Write the backup to a temp path first; if that fails, skip the backup but still proceed with fresh defaults. Never let a backup failure block daemon startup.

### 3. Panic Counter Reset Not Defined (P3)
- P3 says "3 consecutive panics ‚Üí halt". But the counter reset condition is unspecified ‚Äî does it reset after one good cycle? After N good cycles? Undefined behavior here could lead to either too-tolerant (never halts) or too-aggressive (halts after brief flap) behavior.
- **Resolution**: Define explicitly: counter resets to 0 on any successful cycle completion.

### 4. CWD Lock Blocks Diagnostic Commands (P5)
- P5 says "every command validates CWD". But diagnostic commands like `moon status` and `moon health` should work from *any* directory ‚Äî users need them precisely when something is wrong.
- **Resolution**: Exempt `moon status`, `moon health`, and `moon verify` from CWD enforcement. Apply CWD lock only to mutating commands (`moon start`, `moon stop`, `moon run`, `moon embed`, etc.).

---

## üõ†Ô∏è Action Items

### P0 (Immediate)
1. [x] Add `build.rs` to generate compile-time Build UUID.
2. [x] Extend daemon lockfile: PID + timestamp + Build UUID + liveness check.
3. [x] Wrap `run_once_with_options()` in `catch_unwind()` with panic logging.
4. [x] Add state file corruption recovery with auto-backup.

### P1 (Next)
5. [x] Add CWD validation to all CLI commands.
6. [x] Implement graceful shutdown with signal handling.
7. [x] Audit all `Command::new()` sites for timeout coverage.
8. [x] Add secret masking to all status/verify/log output.

### P2 (When Time Permits)
9. [x] Add typo detection for `MOON_*` env vars.
10. [x] Add `moon config --show` command.
11. [x] Add missing `.env` startup warning.
12. [x] Add log rotation.
13. [x] Add `moon health` probe command.
14. [x] Add `--dry-run` to watcher/distill/embed commands.
15. [x] Introduce structured error codes.

## üìé Related
- **LanceDB memory indexing**: Deferred to [mip-lanceDB.md](./mip-lanceDB.md).
- **Config unification (`.env` ‚Üí `moon.toml`)**: Dropped ‚Äî current split follows industry conventions.

---
*Created by Lilac Livint | Master's Maid*
*Revised 2026-02-28 ‚Äî full safety picture + config improvements*
